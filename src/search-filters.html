<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="option-group.html">
<link rel="import" href="moment-js.html">

<link rel="import" href="data/store.html">
<link rel="import" href="data/constants.html">

<dom-module id="search-filters">
  <template>
    <style>
      :host {
        display: block;
        padding: 0 24px;
        width: inherit;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }

      :host([phone]) {
        width: auto;
      }

      :host([phone]) .filters {
        width: auto;
      }

      .title:not([hidden]) {
        display: flex;
      }

      #buttons:not([hidden]) {
        display: flex;
      }

      #done-button {
        margin-left: auto;
      }

      .col {
        width: 100%;
        box-sizing: border-box;
      }

      .col.total,
      .col.date {
        display: flex;
        align-items: flex-end;
      }

      .col span:not(.caption) {
        padding: 0 4px 12px;
        color: rgba(0, 0, 0, 0.3);
      }

      .date span:not(.caption) {
        padding: 0 4px 4px;
      }

      .date vaadin-date-picker {
        display: block;
        flex: 1;
      }

      .col.total vaadin-text-field {
        flex: 1;
      }

      .filters {
        display: flex;
        flex-direction: column;
        padding-bottom: 16px;
      }

      .checkboxes {
        display: inline-block;
        margin-left: 8px;
      }

      .checkboxes>vaadin-checkbox {
        margin-right: 8px;
      }

      .title>span:first-child {
        flex: 1;
      }

      .row {
        display: flex;
        align-items: baseline;
      }

      .row vaadin-text-field {
        min-width: 0px;
        flex: auto;
      }

      .row .delimiter {
        padding: 0 10px;
      }

      .title {
        align-items: baseline;
        padding: 14px 0;
        font-weight: 400;
        font-size: 13px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.13);
        padding-bottom: 6px;
        margin-bottom: 18px;
        margin-top: 4px;
        color: rgba(0, 0, 0, 0.54);
      }

      #buttons {
        margin-top: 32px;
      }

    </style>

    <div class="filters">
      <div class="title" hidden="[[phone]]">
        <span>Filter Expenses</span>
        <vaadin-button class="clear-button" on-tap="_clearFilters" theme="tertiary-inline">Clear Filters</vaadin-button>
      </div>
      <vaadin-date-picker id="from" auto-validate label="From" value="{{filters.start}}" max="[[filters.end]]"></vaadin-date-picker>
      <vaadin-date-picker id="to" auto-validate label="To" value="{{filters.end}}" min="[[filters.start]]"></vaadin-date-picker>
      <div class="row">
        <vaadin-text-field label="Min" value="{{filters.min}}" type="number" step="any">
          <div slot="prefix">$</div>
        </vaadin-text-field>
        <span class="delimiter">â€“</span>
        <vaadin-text-field label="Max" value="{{filters.max}}" type="number" step="any"></vaadin-text-field>
      </div>
      <vaadin-combo-box label="Merchant" items="{{merchants}}" value="{{filters.merchant}}"></vaadin-combo-box>
      <option-group caption="Status" value="{{filters.status}}" items="[[statusOptions]]" label-path="label" value-path="name"></option-group>
      <div id="buttons" hidden="[[!phone]]">
        <vaadin-button class="clear-button" on-tap="_clearFilters" theme="tertiary">Clear Filters</vaadin-button>
        <vaadin-button id="done-button" on-tap="_hideFilters">Done</vaadin-button>
      </div>
    </div>
  </template>

  <script>
    (function() {
      class SearchFiltersElement extends ExpenseManager.ReduxMixin(Polymer.Element) {
        static get is() { return 'search-filters'; }

        static get properties() {
          return {
            srcFilters: {
              type: Object,
              statePath: 'filters.filters',
              observer: '_srcFiltersChanged'
            },

            filters: Object,

            merchants: {
              type: Array,
              statePath: ExpenseManager.select.merchants
            },

            statusOptions: {
              type: Array,
              value: () => ExpenseManager.constants.statuses
            },

            phone: {
              type: Boolean,
              reflectToAttribute: true
            },

            tablet: {
              type: Boolean,
              reflectToAttribute: true
            }
          };
        }

        static get observers() {
          return ['_filtersChanged(filters.*)'];
        }

        _srcFiltersChanged(srcFilters) {
          this.filters = Object.assign({}, srcFilters);
        }

        _filtersChanged() {
          // Ugh. Will do as a object equals
          if (JSON.stringify(this.filters) !== JSON.stringify(this.srcFilters)) {
            this.dispatch('filtersUpdated', this.filters);
          }
        }

        _hideFilters() {
          this.dispatch('hideFilters');
        }

        _clearFilters() {
          this.dispatch('clearFilters');
        }
      }

      customElements.define(SearchFiltersElement.is, SearchFiltersElement);

      /**
       * @namespace ExpenseManager
       */
      window.ExpenseManager = window.ExpenseManager || {};
      ExpenseManager.SearchFiltersElement = SearchFiltersElement;
    })();
  </script>
</dom-module>
