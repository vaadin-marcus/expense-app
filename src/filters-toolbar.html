<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/vaadin-lumo-styles/color.html">
<link rel="import" href="../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="search-filters.html">
<link rel="import" href="data/store.html">
<link rel="import" href="icons.html">

<dom-module id="filters-toolbar">
  <template>
    <style include="lumo-color">
      :host {
        display: flex;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        background: var(--lumo-shade-5pct);
        position: relative;
        z-index: 2;
      }

      :host([phone]) {
        flex-direction: column;
      }

      #toolbar {
        display: flex;
        flex-shrink: 0;
        padding: 0 16px;
        height: 48px;
        align-items: center;
      }

      #filters {
        transition: max-height 400ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      #toolbar[hidden] {
        display: none;
      }

      #total {
        z-index: 2;
        pointer-events: none;
      }

      #total .sum {
        font-size: 32px;
        font-weight: 300;
      }

      .count {
        position: absolute;
        top: 4px;
        right: -4px;
        z-index: 1;
        width: 16px;
        height: 16px;
        overflow: hidden;
        text-align: center;
        border-radius: 50%;
        color: var(--lumo-error-contrast-color);
        background-color: var(--lumo-error-color);
        font-family: var(--lumo-font-family);
        font-size: var(--lumo-font-size-xs);
        line-height: var(--lumo-line-height-xs);
        transform: scale(0);
        transition: all 400ms cubic-bezier(0.4, 0, 0.2, 1);
      }

      .count[has-filters] {
        transform: scale(1);
      }

      .total {
        display: flex;
        flex-direction: column;
        flex: 1;
        line-height: initial;
      }

      .total .sum {
        font-weight: 300;
      }
    </style>

    <div id="toolbar" hidden="[[!phone]]">
      <div class="total">
        <small>To be reimbursed</small>
        <span class="sum">$[[totalOwed]]</span>
      </div>
      <vaadin-button theme="tertiary" on-click="_toggleFilters">
        <iron-icon icon="expense-manager:filters" slot="suffix"></iron-icon>
        <span>Filters</span>
        <div class="count" slot="suffix" has-filters$="[[_hasFilters(appliedFilters)]]">[[appliedFilters]]</div>
      </vaadin-button>
    </div>

    <search-filters phone="[[phone]]" tablet="[[tablet]]" id="filters"></search-filters>
  </template>
  <script>
    (function() {
      /**
       * @memberof ExpenseManager
       */
      class FiltersToolbarElement extends ExpenseManager.ReduxMixin(Polymer.GestureEventListeners(Polymer.Element)) {
        static get is() {
          return 'filters-toolbar';
        }

        static get properties() {
          return {
            /**
             * Whether the filters block is expanded.
             */
            expanded: {
              type: Boolean,
              value: false,
              statePath: 'filters.filtersVisible'
            },

            /**
             * The total owed amount.
             */
            totalOwed: {
              type: Number,
              statePath: ExpenseManager.select.total
            },

            /**
             * The count of applied filters.
             */
            appliedFilters: {
              type: Number,
              statePath: ExpenseManager.select.appliedFilters
            },

            /**
             * Whether the screen matches the tablet breakpoint.
             */
            tablet: {
              type: Boolean,
              reflectToAttribute: true
            },

            /**
             * Whether the screen matches the phone breakpoint.
             */
            phone: {
              type: Boolean,
              reflectToAttribute: true
            }
          };
        }

        static get observers() {
          return [
            '_updateVisibility(phone, tablet, expanded)'
          ];
        }

        _toggleFilters() {
          this.dispatch('toggleFilters');
        }

        /**
         * @param {string} appliedFilters a number of applied filters
         * @return {boolean} true if there s at least one filter applied.
         */
        _hasFilters(appliedFilters) {
          return appliedFilters > 0;
        }

        /**
         * @param {string} phone whether the screen matches the phone breakpoint.
         * @param {string} tablet whether the screen matches the tablet breakpoint.
         * @param {string} expanded true if the filters block is expanded.
         */
        _updateVisibility(phone, tablet, expanded) {
          if (phone) {
            if (expanded) {
              requestAnimationFrame(() => this.$.filters.style.maxHeight = this.$.filters.scrollHeight + 'px');
            } else {
              this.$.filters.style.maxHeight = '0';
            }
          } else {
            this.$.filters.style.maxHeight = 'none';
          }
        }
      }

      customElements.define(FiltersToolbarElement.is, FiltersToolbarElement);

      /**
       * @namespace ExpenseManager
       */
      window.ExpenseManager = window.ExpenseManager || {};
      ExpenseManager.FiltersToolbarElement = FiltersToolbarElement;
    })();
  </script>
</dom-module>
